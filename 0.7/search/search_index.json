{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Open Vault: Deploy","text":""},{"location":"#open-vault-deploy","title":"Open Vault: Deploy","text":""},{"location":"#about","title":"About","text":"<p>Helm Charts and deployment documentation for the Open Vault project</p>"},{"location":"#links","title":"Links","text":"<ul> <li>Production site: openvault.wgbh.org</li> <li>Development site: ov.dev.wgbh-mla.org</li> <li>Admin site: admin.ov.wgbh-mla.org</li> <li>User documentation: wgbh-mla.github.io/ov-wag</li> <li>Developer documentation: wgbh-mla.github.io/ov-deploy</li> <li>Source code: github.com/WGBH-MLA/ov-deploy</li> <li>Helm chart: artifacthub.io/packages/helm/openvault/openvault</li> </ul>"},{"location":"#documentation","title":"Documentation","text":"<ul> <li>For an overview of terms and concepts, see the stack section</li> <li>For installation and setup instructions, see the setup section</li> <li>For management and deployment instructions, see the guides section</li> <li>For reference information, see the reference section</li> </ul>"},{"location":"#credits","title":"Credits","text":"<p>Developed by the GBH Archives at WGBH Boston</p>"},{"location":"about/","title":"About","text":""},{"location":"about/#about","title":"About","text":"<p>This section provides information about the AAPB deployment, and the organizations involved in its development and maintenance, as well as links to additional resources and documentation.</p>"},{"location":"about/#architecture","title":"Architecture","text":"<p>See the Architecture Overview for a high-level description of the AAPB system architecture.</p>"},{"location":"about/#organizations","title":"Organizations","text":""},{"location":"about/#open-vault","title":"Open Vault","text":"<p>The Open Vault (OV) is an online research tool that provides access to Scholar Exhibits and Special Collections, including thousands of hours of interviews, speeches, and other primary source materials from over 70 years of the GBH Archives.</p>"},{"location":"about/#aapb","title":"AAPB","text":"<p>The American Archive for Public Broadcasting (AAPB) is a collaboration between the Library of Congress and GBH to coordinate a national effort to preserve and make accessible significant public broadcasting programs.</p> <p>Visit americanarchive.org for more information</p>"},{"location":"about/#gbh","title":"GBH","text":"<p>See the GBH website for more information about GBH and its initiatives.</p>"},{"location":"about/#media-library-and-archives","title":"Media Library and Archives","text":"<p>The AAPB application is developed and maintained by the Media Library and Archives department (MLA) at GBH in Boston, MA.</p> <p>Visit the Archives website for more information about the Media Library and Archives department.</p>"},{"location":"architecture/","title":"Architecture","text":""},{"location":"architecture/#architecture","title":"Architecture","text":"<p>This section provides a high-level overview of the architecture of the Open Vault application, including its components and how they interact with each other.</p> <p>For installation instructions, see the Quickstart Tutorial.</p> <p></p>"},{"location":"guides/","title":"Guides","text":""},{"location":"guides/#guides","title":"Guides","text":"<p>Management, maintenance and deployment guides for the Open Vault project</p>"},{"location":"guides/#management","title":"Management","text":"<p>See the Management Guide for maintenance and management tasks, such as updating the backend image, scaling the deployment, and managing the database (backup, restore, and migrate).</p>"},{"location":"guides/#deployment","title":"Deployment","text":"<p>See the Deployment Guide for instructions on deploying Open Vault with Helm and updating existing deployments.</p>"},{"location":"guides/deploy/","title":"Deployments","text":""},{"location":"guides/deploy/#deployments","title":"Deployments","text":"<p>Setup</p> <p>If you haven't set up a production environment, follow the steps in Setup first.</p>"},{"location":"guides/deploy/#helm","title":"Helm","text":"<p>The recommended way to deploy Open Vault is using the Helm Chart.</p>"},{"location":"guides/deploy/#install","title":"Install","text":"<p>Add the Helm repository: </p><pre><code>helm repo add ov https://wgbh-mla.github.io/ov-deploy\n</code></pre><p></p> <p>Update the charts: </p><pre><code>helm repo update\n</code></pre><p></p> <p>Customize the values in <code>values.yaml</code> to your needs. You can also use <code>--set</code> to override values on the command line. </p><pre><code>global:\n  backend:\n    image:\n      tag: latest\n</code></pre><p></p> <p>Install the Helm chart: </p><pre><code>helm install ov ov/openvault\n</code></pre><p></p>"},{"location":"guides/deploy/#upgrade","title":"Upgrade","text":"<pre><code>helm upgrade ov ov/openvault\n</code></pre>"},{"location":"guides/manage/","title":"Management and Maintenance","text":""},{"location":"guides/manage/#management-and-maintenance","title":"Management and Maintenance","text":""},{"location":"guides/manage/#backend","title":"Backend","text":"<p>Some common management tasks are described below.</p>"},{"location":"guides/manage/#update-image","title":"Update image","text":"<p>Deployment images can be changed simply by changing the image tag in the deployment configuration.</p> <p>Images are built from each PR to <code>main</code>, as well as pushes to <code>main</code>. To deploy a specific PR, simply change the image tag to the PR number.</p> Change backend image to PR#123<pre><code>      image: ghcr.io/wgbh-mla/ov-wag:pr-123\n</code></pre> <p>To use the latest production image, change the image tag to <code>main</code>.</p> Change backend image to main<pre><code>      image: ghcr.io/wgbh-mla/ov-wag:main\n</code></pre> <p>Change image using <code>kubectl</code></p> <p>This can also be done directly with <code>kubectl</code>:</p> set backend version to PR#123<pre><code>kubectl set image deployment.apps/ov-wag ov-wag=ghcr.io/wgbh-mla/ov-wag:pr-123\n</code></pre>"},{"location":"guides/manage/#scale-deployment","title":"Scale deployment","text":"<p>To scale a deployment, simply change the <code>replicas</code> value in the deployment configuration.</p> Scale backend to 3 replicas<pre><code>  replicas: 3\n</code></pre>"},{"location":"guides/manage/#update-configuration","title":"Update configuration","text":"<p>To update the configuration of a deployment, simply change the value in the deployment configuration.</p> Change backend configuration<pre><code>        - name: OV_DB_PASSWORD\n          value: NEW POSTGRES PASSWORD HERE\n</code></pre>"},{"location":"guides/manage/#database","title":"Database","text":"<p>Data is stored in a PostGreSQL database, hosted in AWS RDS. This page describes common maintenance tasks for the database.</p> <p>For more details about creating and configuring the database, see setup#db.</p>"},{"location":"guides/manage/#backup","title":"Backup","text":"<p>Backups are created automatically by AWS RDS. To create a manual backup, use the AWS console.</p>"},{"location":"guides/manage/#restore","title":"Restore","text":"<p>Restore the database by creating a new RDS instance from a backup instance in the AWS console. </p> <p>Then, update the <code>OV_DB_HOST</code> environment variable in the backend deployment to point to the new database instance.</p>"},{"location":"guides/manage/#migrate","title":"# Migrate","text":"<p>If the Wagtail models have changed, the database must be migrated to reflect the changes. This can be done by running the following command:</p> <pre><code>ov migrate\n</code></pre>"},{"location":"ref/","title":"About the Stack","text":""},{"location":"ref/#about-the-stack","title":"About the Stack","text":"<p>Open Vault is deployed as a number of separate services, built as docker images with GitHub Actions, deployed in a kubernetes cluster, and managed by Argo-CD.</p>"},{"location":"ref/#kubernetes","title":"Kubernetes","text":"<p>Production deployments are run in a Kubernetes cluster, using images built by our CI/CD pipeline. </p> <p>Deployment <code>yaml</code>s are stored in this repository in subfolders by service.</p>"},{"location":"ref/#resources","title":"Resources","text":"<p>Each component of the stack is deployed as a set of Kubernetes resources. They consist of:</p>"},{"location":"ref/#node","title":"Node","text":"A <code>node</code> is a physical or virtual machine that the cluster is running on. The cluster is made up of a number of nodes, which are managed by the cluster."},{"location":"ref/#image","title":"Image","text":"An <code>image</code> is a docker container containing all the code needed to run a single service."},{"location":"ref/#pod","title":"Pod","text":"A <code>pod</code> is the smallest unit of deployment in Kubernetes. It is a single running container (Docker image), which is managed by a deployment. They are designed to be ephemeral, and easily scaled up or down."},{"location":"ref/#deployment","title":"Deployment","text":"A <code>deployment</code> is a set of pods (the running containers). The deployment manages the pods, and ensures that the desired number of pods are running at all times."},{"location":"ref/#service","title":"Service","text":"A <code>service</code> is a network endpoint that can be accessed by other pods. It is used to expose a deployment as a named endpoint, which can be accessed by other pods in the cluster, e.g: <code>http://ov-wag/</code>."},{"location":"ref/#ingress","title":"Ingress","text":"An <code>ingress</code> is a network endpoint that can be accessed by external clients. It is used to expose a service as a named endpoint, which can be accessed by clients outside the cluster. <p>Traefik</p> <p>We use Traefik as our ingress controller, which is configured to route incoming requests to the appropriate service. It also handles SSL termination, redirects HTTP requests to HTTPS, and allows for custom routing rules.</p>"},{"location":"ref/#configmap","title":"ConfigMap","text":"A <code>configmap</code> is a set of key-value pairs that can be accessed by pods. It is used to store configuration values that are needed by the pods."},{"location":"ref/#secret","title":"Secret","text":"A <code>secret</code> is a secure set of key-value pairs that can be accessed by pods. It is used to store sensitive configuration values that are needed by the pods."},{"location":"ref/#namespace","title":"Namespace","text":"A <code>namespace</code> is a group of resources that are deployed together. Namespaces are used to separate different deployments, like production and demo. <p>Namespacess</p> <p>Currently, we deploy two namespaces:</p> <ul> <li><code>ov</code> Production</li> <li><code>ov-demo</code> Demo</li> </ul>"},{"location":"ref/#argo-cd","title":"Argo-CD","text":"<p>Argo-CD is a declarative, GitOps continuous delivery tool for Kubernetes. </p> <p>It is configured to watch for changes in the <code>main</code> branch of this repository, and automatically deploy changes to the cluster.</p>"},{"location":"ref/#deployments","title":"Deployments","text":"<p>Argo-CD is configured to deploy the following deployments:</p>"},{"location":"ref/#ov-wag","title":"ov-wag","text":"The backend service, running the Wagtail CMS and API."},{"location":"ref/#ov-frontend","title":"ov-frontend","text":"The frontend service, running the Remix server."},{"location":"ref/#postgres","title":"postgres","text":"A non-production database service, running PostgreSQL. <p>Production Database</p> <p>The production database is managed by AWS RDS, and is not deployed by Argo-CD.</p> <p>Multiple Deployments</p> <p>A deployment can be deployed multiple times to the same cluster, in different namespaces, with different configurations (e.g. different branches)</p> <p>The two primary deployments go to the <code>ov</code> and <code>ov-demo</code> namespaces, but more could be added without affecting these.</p>"},{"location":"ref/#terms","title":"Terms","text":"<p>The following are some definitions for some of the terms used in this guide:</p>"},{"location":"ref/#production","title":"Production","text":"The fully deployed stack, publicly available to all clients Deployment is orchestrated through <code>kubernetes</code>."},{"location":"ref/#demo-staging","title":"Demo / Staging","text":"A separate production stack, used to test changes and maintain a live working backup. This will be available on a different domain than the production stack, running in a separate namespcae."},{"location":"ref/#ci","title":"CI","text":"Continuous Integration. The process of automatically building and testing code changes.  <p>GitHub Actions</p> <p>This is done with GitHub Actions workflows defined in the <code>.github/workflows</code> folder of the <code>ov-wag</code> and <code>ov-frontend</code> repositories.</p> <p>Builds are performed automatically on every push to the <code>main</code> branch, and on every pull request, tagged with <code>pr-&lt;number&gt;</code>.</p> <p>Builds are performed regardless of tests passing or failing.</p>"},{"location":"ref/#cd","title":"CD","text":"Continuous Deployment. The process of automatically deploying code changes to the production environment. <p>Argo-CD</p> <p>Deployments are managed by Argo-CD, which is configured to watch for changes in the  <code>main</code> branch. When a change is detected, Argo-CD will pull the latest configuration from the repository, compare it against the running system, and if necessary, apply changes to the cluster.</p>"},{"location":"ref/#frontend","title":"Frontend","text":"Remix server delivering the HTML + Javascript code to the user.  <p>Source: github.com/WGBH-MLA/ov-frontend/</p> <p>Docker: ghcr.io/wgbh-mla/ov-frontend</p>"},{"location":"ref/#backend","title":"Backend","text":"Wagtail (Django) Headless CMS for admin content creation and management, and API to serve the frontend with content. <p>Source: github.com/WGBH-MLA/ov-wag</p> <p>Docker: ghcr.io/wgbh-mla/ov-wag</p>"},{"location":"ref/#db","title":"DB","text":"Database. Using PostgreSQL Database image<pre><code>  image: postgres:16-alpine\n</code></pre>"},{"location":"ref/#proxy","title":"Proxy","text":"Traefik Reverse Proxy. Handles routing of incoming requests to the appropriate service. Also handles SSL termination, redirects HTTP requests to HTTPS, and allows for custom routing rules."},{"location":"ref/#call-sequence","title":"Call sequence","text":"<p>The following diagram describes the call sequence for incoming requests:</p> <pre><code>sequenceDiagram\nClient -&gt;&gt; Proxy: requests page\nProxy --&gt;&gt; Frontend: Traefik proxies request\nFrontend -&gt;&gt; Backend: Frontend  fetches latest data from API\nBackend -&gt;&gt; DB: Backend polls the database\nDB -&gt;&gt; Backend: return database results\nBackend -&gt;&gt; Frontend: return API results\nFrontend -&gt;&gt; Proxy: return built page with latest results\nProxy --&gt;&gt; Client: return response</code></pre>"},{"location":"tutorials/quickstart/","title":"Quickstart","text":""},{"location":"tutorials/quickstart/#quickstart","title":"Quickstart","text":""},{"location":"tutorials/quickstart/#prerequisites","title":"Prerequisites","text":"<p>These instructions assume you have the following:</p> <ul> <li>A working Kubernetes cluster</li> <li><code>kubectl</code>, configured to connect to your cluster</li> <li>Argo-CD installed and configured</li> <li>Traefik installed and configured as an ingress controller</li> <li>A running PostgreSQL database</li> </ul>"},{"location":"tutorials/quickstart/#namespace","title":"Namespace","text":"<p>Create a new production namespace called <code>ov</code>:</p> <pre><code>kubectl create namespace ov\n</code></pre> <p>Set the current context to the new namespace: </p><pre><code>kubectl config set-context --current --namespace=ov\n\n# Verify the current context\nkubectl config view --minify | grep namespace:\n</code></pre><p></p>"},{"location":"tutorials/quickstart/#database","title":"Database","text":"<p>Create a new database called <code>ov</code> and a new user called <code>postgres</code> and a secure password.</p> Database configuration<pre><code>POSTGRES_USER=postgres\nPOSTGRES_PASSWORD=\"YOUR POSTGRES PASSWORD HERE\"\nPOSTGRES_DB=ov\n</code></pre> Generating a password <p>This command will generate a new secure password:</p> <pre><code>openssl rand -base64 24\n</code></pre> <p>Increace the final number to increase the length and strength of the password.</p>"},{"location":"tutorials/quickstart/#secrets","title":"Secrets","text":"<p>Create the Backend secrets file</p>"},{"location":"tutorials/quickstart/#example","title":"Example","text":"ov-wag/secret.yaml<pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: ov-wag-secret\n  namespace: ov\nstringData:\n  OV_DB_PASSWORD: YOUR POSTGRES PASSWORD HERE\n  OV_SECRET_KEY: RanDOmSeCrEtKeY_fOr_sESsion_cOOkies\n  AWS_ACCESS_KEY_ID : # AWS IAM user access key\n  AWS_SECRET_ACCESS_KEY: # AWS IAM user secret key\n</code></pre> <p>Apply this to the cluster:</p> Apply secrets<pre><code>kubectl apply -f ov-wag/secret.yaml\n</code></pre>"},{"location":"tutorials/quickstart/#ingress","title":"Ingress","text":"<p>If necessary, modify the ingress file with the correct domain name:</p> <p>Applies to frontend or backend.</p>"},{"location":"tutorials/quickstart/#example_1","title":"Example","text":"<p>The following frontend example:</p> <ul> <li>Routes incoming traffic that matches <code>Host: ov.wgbh-mla.org</code> to the frontend service</li> <li>Redirects HTTP to HTTPS</li> <li>Terminates the TLS connection</li> <li>Automatically manages the SSL certificate with LetsEncrypt</li> </ul> ov-frontend/ingress.yaml<pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: ov-frontend-ingress\n\nspec:\n  rules:\n    - host: ov.wgbh-mla.org\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: ov-frontend\n                port:\n                  number: 80\n\n  tls:\n    - hosts:\n        - ov.wgbh-mla.org\n      secretName: ov-frontend-tls\n</code></pre>"}]}